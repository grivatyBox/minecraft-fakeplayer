# 假人持久化能力

## 新增需求

### 需求：创建假人时保存元数据
系统在创建假人时必须将假人元数据保存到持久化存储。

**元数据包括**：
- 假人 UUID 和序列名
- 创建者 UUID 和名称
- 创建时间戳
- 生成位置（世界、x、y、z、yaw、pitch）
- 生成选项（无敌、可碰撞、拾取物品等）
- **活跃动作列表**：保存所有正在执行的动作及其配置
  - 动作类型（ATTACK、MINE、MOVE、JUMP、USE、LOOK_AT_NEAREST_ENTITY 等）
  - 动作配置（remains 持续时间、mode 模式、target 目标等）

#### 场景：假人创建成功
- **当** 通过命令创建假人时
- **那么** 系统必须创建/更新 `active-fakeplayers.json`
- **并且** 元数据必须包含所有必需字段
- **并且** 文件必须是有效的 JSON

#### 场景：假人被移除
- **当** 假人被移除（通过命令或插件关闭）
- **那么** 系统必须从 `active-fakeplayers.json` 中移除该假人的元数据
- **并且** playerdata 文件必须保留（如果 `persistent-data: true`）

### 需求：从存储加载假人元数据
系统必须在启动时从持久化存储加载假人元数据。

#### 场景：元数据文件存在且有效
- **当** 插件加载且 `active-fakeplayers.json` 存在
- **并且** 文件包含有效的 JSON
- **那么** 系统必须成功解析元数据
- **并且** 恢复所有记录的假人

#### 场景：元数据文件缺失或无效
- **当** 插件加载且 `active-fakeplayers.json` 不存在
- **或** 文件包含无效的 JSON
- **那么** 系统必须记录警告消息
- **并且** 继续正常运行（不恢复假人）
- **并且** 在下次创建假人时创建新的空元数据文件

### 需求：原子性文件更新
系统必须原子性地更新元数据文件以防止数据损坏。

#### 场景：并发元数据更新
- **当** 同时创建或移除多个假人
- **那么** 系统必须使用文件锁定或原子写入操作
- **并且** 确保 JSON 文件保持有效

### 需求：元数据文件位置
元数据文件必须存储在 `plugins/fakeplayer/active-fakeplayers.json`。

#### 场景：标准文件位置
- **当** 插件需要访问元数据文件
- **那么** 它必须位于 `plugins/fakeplayer/active-fakeplayers.json`
- **并且** 如果父目录不存在则创建

### 需求：元数据版本控制
元数据文件必须包含版本号以便未来兼容性。

#### 场景：存在版本字段
- **当** 创建元数据文件时
- **那么** 它必须包含 `version` 字段
- **并且** 当前版本必须为 1
- **并且** 系统必须支持从旧版本迁移（如果需要）

### 需求：备份损坏的元数据
系统必须在主要更新前创建元数据文件的备份。

#### 场景：备份创建
- **当** 元数据文件即将被覆盖时
- **那么** 系统必须创建名为 `active-fakeplayers.json.backup` 的备份文件
- **并且** 最多保留 3 个备份文件（轮换旧备份）

### 需求：保存假人的动作状态
系统必须保存假人的所有活跃动作及其配置到元数据文件。

#### 场景：保存攻击动作
- **假设** 一个假人正在执行攻击动作（ATTACK）
- **并且** 配置为自动模式（mode: AUTO），目标为最近实体
- **当** 元数据被保存
- **那么** 必须保存动作类型为 `ATTACK`
- **并且** 必须保存 `remains` 值（持续时间）
- **并且** 必须保存 `mode` 为 `AUTO`
- **并且** 必须保存 `target` 为 `NEAREST`

#### 场景：保存多个动作
- **假设** 一个假人同时执行多个动作（如攻击 + 看向实体）
- **当** 元数据被保存
- **那么** 必须保存所有活跃动作
- **并且** 每个动作必须包含其完整配置
- **并且** 动作列表必须保持顺序

#### 场景：保存动作目标位置
- **假设** 一个假人的移动动作有目标位置
- **当** 元数据被保存
- **那么** 必须保存目标位置的坐标（x, y, z, yaw, pitch）
- **并且** 必须保存世界名称

#### 场景：动作停止时从元数据移除
- **当** 一个假人的动作被停止或完成（remains 倒计时结束）
- **那么** 系统必须从元数据中移除该动作
- **并且** 更新 `active-fakeplayers.json` 文件
