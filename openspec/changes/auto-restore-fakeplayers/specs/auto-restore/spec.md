# 自动恢复能力

## 新增需求

### 需求：服务器启动时自动恢复假人
系统必须在服务器关闭前自动恢复所有活跃的假人。

#### 场景：启动时成功自动恢复
- **假设** 配置中启用了自动恢复
- **并且** 元数据中有记录的假人
- **当** 服务器完成主世界加载
- **那么** 系统必须恢复所有假人
- **并且** 每个假人必须恢复到最后状态
- **并且** 系统必须记录恢复的假人数量

#### 场景：自动恢复被禁用
- **假设** 配置中禁用了自动恢复
- **当** 服务器启动
- **那么** 系统不得恢复任何假人
- **并且** 元数据文件仍应更新以供将来使用

#### 场景：延迟恢复
- **假设** 启用了自动恢复
- **并且** `delay-seconds` 配置为 5
- **当** 主世界加载完成
- **那么** 系统必须等待 5 秒后才开始恢复
- **然后** 继续恢复假人

### 需求：完整恢复假人状态
系统必须将每个假人恢复到其确切的保存状态。

**状态包括**：
- 位置（世界、x、y、z、yaw、pitch）
- 背包内容
- 生命值和食物等级
- 活跃效果（如果有）
- 生成选项（无敌、可碰撞等）
- **活跃动作列表**：
  - 动作类型（ATTACK、MINE、MOVE、JUMP、USE、LOOK_AT_NEAREST_ENTITY 等）
  - 每个动作的完整配置（remains、mode、target、location 等）

#### 场景：完整状态恢复
- **假设** 一个带有物品和特定位置的假人
- **当** 假人被恢复
- **那么** 它必须出现在保存的位置
- **并且** 背包必须包含所有保存的物品
- **并且** 生命值和食物必须匹配保存的值
- **并且** 生成选项必须被恢复（无敌、可碰撞等）
- **并且** 所有保存的动作必须被恢复

#### 场景：恢复攻击动作
- **假设** 假人保存时正在执行攻击动作
- **并且** 动作配置为 `ATTACK`，`mode: AUTO`，`target: NEAREST`
- **当** 假人被恢复
- **那么** 系统必须重新启动攻击动作
- **并且** 使用保存的配置（AUTO 模式，最近实体目标）
- **并且** 动作必须立即开始执行

#### 场景：恢复挖掘动作
- **假设** 假人保存时正在执行挖掘动作
- **并且** 动作配置包含目标位置
- **当** 假人被恢复
- **那么** 系统必须重新启动挖掘动作
- **并且** 移动到保存的目标位置开始挖掘

#### 场景：恢复多个动作
- **假设** 假人保存时有多个活跃动作（攻击 + 看向实体）
- **当** 假人被恢复
- **那么** 系统必须按保存的顺序恢复所有动作
- **并且** 每个动作必须使用保存的配置
- **并且** 所有动作必须同时恢复并开始执行

#### 场景：恢复有限持续时间的动作
- **假设** 假人保存时有一个 `remains: 100` 的动作（持续 100 tick）
- **当** 假人被恢复
- **那么** 系统必须恢复该动作及其剩余持续时间
- **并且** 从恢复时刻开始重新计时

#### 场景：恢复到未加载的世界
- **假设** 假人的保存世界未加载
- **当** 系统尝试恢复该假人
- **那么** 必须跳过该假人的恢复
- **并且** 必须记录警告
- **并且** 其他假人仍必须被恢复

### 需求：优雅处理恢复失败
系统必须在某些假人恢复失败时继续恢复其他假人。

#### 场景：单个假人恢复失败
- **假设** 要恢复多个假人
- **并且** 一个假人的数据损坏
- **当** 恢复进程运行
- **那么** 必须跳过损坏的假人
- **并且** 必须记录包含详细信息的错误
- **并且** 其他假人仍必须被恢复
- **并且** 摘要日志必须显示"X 成功，Y 失败"

#### 场景：创建者不再存在
- **假设** 一个假人的创建者已被删除
- **当** 假人被恢复
- **那么** 假人仍必须被恢复
- **并且** 创建者信息必须保留在元数据中
- **并且** 不得记录错误

#### 场景：UUID 冲突
- **假设** 一个假人的 UUID 与现有实体冲突
- **当** 恢复进程检测到冲突
- **那么** 必须跳过该假人
- **并且** 必须记录包含冲突详情的警告
- **并且** 其他假人必须继续被恢复

### 需求：限制并发恢复
系统必须限制同时恢复的假人数量以防止服务器过载。

#### 场景：遵守最大并发恢复限制
- **假设** `max-concurrent-restore` 设置为 5
- **并且** 有 20 个假人要恢复
- **当** 恢复进程开始
- **那么** 系统必须一次恢复 5 个假人
- **并且** 等待每批完成后再开始下一批
- **并且** 继续直到所有假人被恢复

#### 场景：未配置限制
- **假设** 未设置 `max-concurrent-restore` 或为 0
- **当** 恢复进程开始
- **那么** 系统必须同时恢复所有假人
- **并且** 不应用批量限制

### 需求：记录恢复进度
系统必须记录恢复进程的详细进度。

#### 场景：进度记录
- **当** 假人恢复开始
- **那么** 系统必须记录"开始自动恢复 X 个假人..."
- **并且** 对每个恢复的假人，记录"已恢复假人 {name}"
- **并且** 完成后，记录"自动恢复完成：X 成功，Y 失败，Z 跳过"

#### 场景：没有假人要恢复
- **假设** 元数据文件存在但不包含假人
- **当** 恢复进程运行
- **那么** 系统必须记录"没有假人要恢复"
- **并且** 优雅退出

### 需求：在世界加载完成后恢复
系统必须只在主世界完全加载后才开始恢复。

#### 场景：等待世界加载
- **当** 插件加载
- **那么** 系统必须注册 WorldLoadEvent 监听器
- **并且** 等待主世界（普通环境）加载
- **并且** 只有那时才开始恢复进程

#### 场景：处理多个世界
- **假设** 服务器加载了多个世界
- **当** 主世界加载
- **那么** 系统必须开始恢复
- **并且** 其他世界中的假人在那些世界加载时被恢复
- **或** 如果那些世界从未加载则跳过

### 需求：支持基于配置的过滤
系统必须支持基于配置过滤要恢复的假人。

#### 场景：按创建者过滤
- **假设** 为特定创建者的配置过滤器
- **当** 恢复运行
- **那么** 只有匹配创建者的假人才被恢复
- **并且** 其他的被跳过并记录日志消息

#### 场景：按世界过滤
- **假设** 为特定世界的配置过滤器
- **当** 恢复运行
- **那么** 只有匹配世界中的假人被恢复
- **并且** 其他的被跳过并记录日志消息

### 需求：手动恢复命令
系统必须提供手动触发恢复的命令。

#### 场景：手动恢复命令
- **假设** 自动恢复被禁用
- **当** 管理员运行 `/fp restore`
- **那么** 系统必须立即恢复所有待处理的假人
- **并且** 遵循与自动恢复相同的所有规则（批处理、错误处理等）
- **并且** 需要 `fakeplayer.restore` 权限

#### 场景：恢复特定假人
- **当** 管理员运行 `/fp restore <name>`
- **那么** 系统必须只恢复指定的假人
- **并且** 向管理员报告成功或失败

### 需求：防止重复恢复
系统不得恢复已存在的假人。

#### 场景：假人已在线
- **假设** 一个假人已在线（手动创建）
- **并且** 同一假人在元数据文件中
- **当** 恢复运行
- **那么** 必须跳过重复的假人
- **并且** 必须记录信息消息
- **并且** 现有假人必须保持不变
